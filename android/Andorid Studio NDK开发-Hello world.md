#Andorid Studio NDK开发-Hello World

介绍了在`Android Studio`中配置NDK的开发环境:[Android Studio NDK开发-环境配置](https://juejin.im/post/58d705321b69e6006bb3266e)，NDK开发环境配置完成之后，就要写一下著名的`Hello World`程序了。
在开始之前需要先介绍下Java和c/c++通信：JNI，JNI(Java Native Inteface)是Java平台的一部分，它允许Java代码和其他语言写的代码进行交互。尤其是c/c++,但是并不妨碍你使用其他语言，只要调用约定支持就可以了。NDK上Java和c/c++有两种交互方式:
* 使用c/c++实现"natvie methods",在Java中通过预先定义好的规则来调用
* JNI支持c/c+通过一定的规则直接访问Java中的类，常量，变量等

这里使用的是第一种交互方式，即Java调用c/c++。
## 创建JNI目录
打开`Android Studio`,新建一个项目,右键点击`App`(对应的module)新建一个JNI目录:

![新建JNI目录](https://user-gold-cdn.xitu.io/2017/3/27/698d64dfd05a5dca448befb73e95ad91) 
    操作步骤:App->New->Folder->JNI Folder 
在**main**目录中就会出现一个`jni`目录:
![jni目录](https://user-gold-cdn.xitu.io/2017/3/27/07f99e73abf0a7690ed43de7edf5a9ec)


## 新建Java类
新建一个HelloJni.java的类,用来和NDK交互:

    package com.example.jjz.jni;
    public class HelloJni {
        //定义一个jni的方法
        public native String sayHello();

    }


HelloJni中使用关键词`native`定义了一个方法，`native`:一个Natvie Method就是一个Java调用非Java代码的接口，该方法的实现由c/c++实现。
方法定义完之后可以看到一个提示，没有`sayHello`的实现。

![没有实现](https://user-gold-cdn.xitu.io/2017/3/27/739beb81aef3526d691d5dde32068432)

这是因为并没有实现对应的c/c++的方法，下面就需要使用c/c++使用`sayHello`方法。

## gradle中支持NDK

`Android Studio`从1.3开始就支持了对于NDK的开发，可以在gradle配置NDK的开发选项，首先在`bulid.gradle`中设置ndk的的moduleName:

    defaultConfig {
        applicationId "com.example.jjz.jni"
        minSdkVersion 15
        targetSdkVersion 23
        versionCode 1
        versionName "1.0"
        //指定.so的目录
         sourceSets.main{
            jniLibs.srcDir 'src/main/libs'
        }
        ndk{
            moduleName 'hello'
        }
    }


在进行同步gradle的时候出现了一个错误:

    NDK integration is deprecated in the current plugin
    set "android.useDeprecatedNdk=true"in gradle.properties to continue using the current NDK integration

根据提示需要在gradle.properties中设置`android.useDeprecatedNdk=true`。

#生成.h文件

`Java`中使用调用NDK的方法，要先生成.h头文件，`JNI`的.h文件规则：
1. 方法的关键词使用`JNIEXPORT`
2. 方法的返回值根据预先定好的规则使用对应的类型比如:int要使用jint
3. 被转换的Java类要全路径进行转换，方法名中必须有类的完整包名，`.`变成`_`。
4. jni的方法名还必须包含类名和类的方法名，也是使用`_`分割

例如上面的`sayHello`方法转换为JNI的方法为:

    JNIEXPORT jint JNICALL
    Java_com_example_jjz_jni_HelloJni_sayHello(JNIEnv *env, jobject instance, jint a) {
    }

这种定义规则很复杂，不容易手写，还好可以通过`javah`命令自动生成。
在app/目录下运行命令:
>javah -d src/main/jni/ -classpath build/intermediates/classes/debug/ com.example.jjz.jni.HelloJni

其中`-d`是生成.h文件的保存目录。
`-classpath`是指定.class所在的目录，项目build成功之后，会在`build/intermediates/classes/debug/`目录里生成.class文件。
`com.example.jjz.jni.HelloJni`是包名加上类名。
就可以在jni目录下得到一个`com_example_jjz_jni_HelloJni.h`的文件，文件内容如下：


    /* DO NOT EDIT THIS FILE - it is machine generated */
    #include <jni.h>
    /
    * Header for class com_example_jjz_jni_HelloJni */

    #ifndef _Included_com_example_jjz_jni_HelloJni
    #define _Included_com_example_jjz_jni_HelloJni
    #ifdef __cplusplus
    extern "C" {
    #endif
    /*
     * Class:     com_example_jjz_jni_HelloJni
     * Method:    sayHello
     * Signature: ()Ljava/lang/String;
     */
    JNIEXPORT jstring JNICALL Java_com_example_jjz_jni_HelloJni_sayHello
      (JNIEnv *, jobject);

    #ifdef __cplusplus
    }
    #endif
    #endif


##  实现.h文件
`.h`文件只是一个声明文件，还需要实现.h文件中定义的方法
* 添加.c文件
新建文件`com_example_jjz_jni_HelloJni.c`用来文件实现`sayHello`方法。

        #include "com_example_jjz_jni_HelloJni.h"
        JNIEXPORT void JNICALL JNIEXPORT jstring JNICALL Java_com_example_jjz_jni_HelloJni_sayHello(JNIEnv *env, jobject object) {
        return (*env)->NewStringUTF(env, "Hello Jni");
        }

* 添加Application.mk文件
 
        APP_MODULES := hello
        APP_ABI :=all

* 添加Android.mk文件

        LOCAL_PATH := $(call my-dir)
        include $(CLEAR_VARS)
        LOCAL_MODULE :=hello
        LOCAL_SRC_FILES =: com_example_jjz_jni_HelloJni.c
        include $(BUILD_SHARED_LIBRARY)


## 编译调用
文件添加完成之后就可以使用NDK编译了，在../app/src/main/jni目录下，运行命令
>ndk-build

运行之后可以看到生成的libhello.so文件:

![libhello.so](https://user-gold-cdn.xitu.io/2017/3/27/cd479057d6f669ca00d202f313fbd6e6)

注意这个时候`.so`文件已经生成，但是在java中并没有加载`.so`类库，必须加载`.so`类库才能被Java使用，加载的方式使用使用函数`System.loadLiabrary("hello")`：

    public class HelloJni {
        static {
            //加载.so类库，加载的名称去掉lib
            System.loadLibrary("hello");
        }
        public native int sayHello(int a);
    }

项目地址：https://github.com/jjz/android/tree/master/Jni





